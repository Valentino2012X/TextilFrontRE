<!-- src/app/components/usuario/usuario-insert/usuario-insert.html -->

<div class="tc-page">
  <!-- Header -->
  <section class="tc-hero">
    <div class="tc-hero-left">
      <div class="tc-hero-icon">
        <span class="material-icons">{{ edicion ? 'edit' : 'person_add' }}</span>
      </div>

      <div class="tc-hero-text">
        <h1 class="tc-hero-title">{{ edicion ? 'Editar usuario' : 'Nuevo usuario' }}</h1>
        <p class="tc-hero-subtitle">
          {{
            edicion
              ? 'Actualiza la información del usuario.'
              : 'Registra un nuevo usuario en el sistema.'
          }}
        </p>
      </div>
    </div>

    <div class="tc-hero-right">
      <span class="tc-pill">{{ edicion ? 'Edición' : 'Registro' }}</span>
    </div>
  </section>

  <!-- Form -->
  <section class="tc-card">
    <form class="tc-form" [formGroup]="form" (ngSubmit)="aceptar()">
      <div class="tc-grid">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombreUsuario" />
          <mat-error *ngIf="form.get('nombreUsuario')?.hasError('required')">
            El nombre es obligatorio
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput formControlName="emailUsuario" />
          <mat-error *ngIf="form.get('emailUsuario')?.hasError('required')">
            El email es obligatorio
          </mat-error>
          <mat-error *ngIf="form.get('emailUsuario')?.hasError('email')">
            Email inválido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Username</mat-label>
          <input matInput formControlName="username" />
          <mat-error *ngIf="form.get('username')?.hasError('required')">
            El username es obligatorio
          </mat-error>
          <mat-error *ngIf="form.get('username')?.hasError('maxlength')">
            El username debe tener un máximo de 50 caracteres.
          </mat-error>
        </mat-form-field>

        <!-- Password (solo en registro) -->
        <mat-form-field *ngIf="!edicion" appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input matInput type="password" formControlName="password" />
          <mat-error *ngIf="form.get('password')?.hasError('required')">
            La contraseña es obligatoria
          </mat-error>
          <mat-error *ngIf="form.get('password')?.hasError('minlength')">
            La contraseña debe tener al menos 8 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="telefonoUsuario" maxlength="9" />
          <mat-error *ngIf="form.get('telefonoUsuario')?.hasError('required')">
            El teléfono es obligatorio
          </mat-error>
          <mat-error *ngIf="telefono?.hasError('minlength') && !telefono?.hasError('pattern')">
            El teléfono no puede tener menos de 9 dígitos
          </mat-error>
          <mat-error *ngIf="telefono?.hasError('pattern') && telefono?.value">
            Solo se permiten números
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Dirección</mat-label>
          <input matInput formControlName="direccionUsuario" />
          <mat-error *ngIf="form.get('direccionUsuario')?.hasError('required')">
            La dirección es obligatoria
          </mat-error>
        </mat-form-field>

        <!-- URL de foto -->
        <mat-form-field appearance="outline" class="full-width tc-span-2">
          <mat-label>URL de foto de perfil (opcional)</mat-label>
          <input matInput formControlName="fotoUrl" placeholder="https://ejemplo.com/mi-foto.jpg" />
        </mat-form-field>

        <!-- Upload de foto (solo útil sobre todo en edición, porque ya hay id) -->
        <div class="tc-span-2 usuario-foto-upload">
          <label class="perfil-upload-label">Foto de perfil (upload opcional)</label>

          <div class="usuario-foto-row">
            <img
              class="usuario-foto-preview"
              [src]="previewUrl || form.value.fotoUrl || 'assets/avatar-default.png'"
              alt="Foto de perfil"
            />

            <div class="usuario-foto-actions">
              <input
                type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                class="perfil-file-input"
              />

              <button
                mat-raised-button
                type="button"
                class="tc-btn-ghost"
                (click)="subirFoto()"
                [disabled]="!selectedFile || !edicion || subiendo"
              >
                {{ subiendo ? 'Subiendo...' : 'Subir foto' }}
              </button>

              <div class="perfil-msg success" *ngIf="uploadSuccess">
                {{ uploadSuccess }}
              </div>
              <div class="perfil-msg error" *ngIf="uploadError">
                {{ uploadError }}
              </div>
            </div>
          </div>
        </div>

        <!-- Fecha de registro (solo una vez) -->
        <mat-form-field appearance="outline" class="full-width tc-span-2">
          <mat-label>Fecha de registro</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="fechaRegistroUsuario" />
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <div class="tc-span-2 tc-row">
          <mat-checkbox formControlName="enabled">Activo</mat-checkbox>
        </div>

        <mat-form-field appearance="outline" class="full-width tc-span-2">
          <mat-label>Rol</mat-label>
          <mat-select formControlName="idRol" panelClass="tc-select-panel">
            <mat-option *ngFor="let r of listaRoles" [value]="r.idRol">
              {{ r.nombreRol }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('idRol')?.hasError('required')">
            Debes seleccionar un rol
          </mat-error>
        </mat-form-field>
      </div>

      <div class="tc-actions-row">
        <button mat-raised-button class="tc-btn-primary" type="submit">
          {{ edicion ? 'Guardar cambios' : 'Registrar' }}
        </button>
        <button mat-raised-button class="tc-btn-ghost" type="button" (click)="cancelar()">
          Cancelar
        </button>
      </div>
    </form>
  </section>
</div>
